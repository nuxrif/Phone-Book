<!doctype html>
<html lang="bn">
<head>
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Contacts ‚Äî iOS Style (Pro)</title>
<meta name="theme-color" content="#f8f8f8"/>
<style>
:root{
  --bg:#f8f8f8;--card:#fff;--muted:#6b7280;--text:#111;--tint:#007aff;
  --hair:#e5e5ea;--shadow:0 1px 3px rgba(0,0,0,.06);
}
.dark{
  --bg:#0b0c0f;--card:#14161a;--muted:#9aa3af;--text:#e5e7eb;--tint:#4f9cff;--hair:#22252b;--shadow:none;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:15px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Noto Sans",system-ui,sans-serif;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}
.safe{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
.navbar{position:sticky;top:0;z-index:50;background:rgba(248,248,248,.8);backdrop-filter:saturate(180%) blur(20px);border-bottom:1px solid var(--hair)}
.dark .navbar{background:rgba(11,12,15,.8)}
.navin{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:8px}
.title{font-weight:700;margin-right:auto}
.btn,.seg button{background:var(--tint);color:#fff;border:0;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.btn.gray{background:#e5e7eb;color:#111}
.dark .btn.gray{background:#2a2f37;color:#e5e7eb}
.wrap{max-width:980px;margin:0 auto;padding:0 12px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 4px;border-bottom:1px solid var(--hair);background:var(--bg);position:sticky;top:44px;z-index:40}
.search{display:flex;align-items:center;gap:8px;background:#e9eaed;border-radius:12px;padding:8px 10px}
.dark .search{background:#1d2026}
.search input{border:0;outline:0;background:transparent;width:220px;max-width:60vw;font-size:16px;color:var(--text)}
.seg{display:inline-flex;background:#e9eaed;border-radius:10px;padding:2px}
.dark .seg{background:#1d2026}
.seg button{background:transparent;color:var(--text);padding:6px 10px;border-radius:8px}
.seg button.active{background:var(--card)}
select{background:var(--card);color:var(--text);border:1px solid var(--hair);border-radius:10px;padding:8px 10px}
.hint{color:var(--muted);font-size:12px}
.list{position:relative;padding-bottom:90px}
.section{margin-top:8px}
.sectitle{position:sticky;top:96px;background:var(--bg);padding:4px 8px;color:var(--muted);font-weight:600;font-size:12px;border-bottom:1px solid var(--hair)}
.cell{display:flex;align-items:center;gap:12px;padding:12px 8px;background:var(--card);border-bottom:1px solid var(--hair);box-shadow:var(--shadow)}
.avatar{width:40px;height:40px;border-radius:50%;background:#cfe2ff;display:flex;align-items:center;justify-content:center;font-weight:700}
.dark .avatar{background:#2a78ff33}
.nm{font-weight:600}
.sub{font-size:12px;color:var(--muted)}
.right{margin-left:auto;color:var(--muted)}
.empty{padding:28px;text-align:center;color:var(--muted)}
.az{position:fixed;right:6px;top:140px;bottom:40px;width:20px;display:flex;flex-direction:column;align-items:center;gap:2px;user-select:none}
.az a{font-size:11px;color:#7c7c7c;text-decoration:none;padding:2px}
.dark .az a{color:#9aa3af}
.sheet-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:60}
.sheet{position:absolute;left:0;right:0;bottom:0;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;padding:14px;box-shadow:0 -8px 30px rgba(0,0,0,.15);transform:translateY(100%);transition:transform .28s ease}
.sheet.show{transform:translateY(0)}
.sheet-head{display:flex;gap:10px;align-items:center;margin-bottom:6px}
.btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.footer{padding:14px;text-align:center;color:var(--muted);font-size:12px}
/* number list */
.numlist{display:flex;flex-direction:column;gap:8px;margin:8px 0}
.numrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.num{font-weight:600;padding:6px 10px;border-radius:8px;background:#eef2ff}
.dark .num{background:#202532}
.btn.sm{padding:6px 10px;border-radius:8px;font-weight:600}
/* form */
.form{display:grid;gap:8px}
.form input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--hair);background:var(--card);color:var(--text)}
</style>
</head>
<body class="safe">
  <div class="navbar">
    <div class="navin">
      <div class="title">Contacts</div>
      <button id="addBtn" class="btn gray">Add</button>
      <button id="exportAllBtn" class="btn gray">Export All (.vcf)</button>
      <button id="themeBtn" class="btn gray" title="Dark/Light">üåô</button>
      <button id="reloadBtn" class="btn">Reload CSV</button>
    </div>
  </div>

  <div class="toolbar">
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" placeholder="‡¶®‡¶æ‡¶Æ/‡¶®‡¶Æ‡ßç‡¶¨‡¶∞/‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö‚Ä¶"/>
      <button id="clear" class="btn gray" style="padding:6px 10px">Clear</button>
    </div>
    <div class="seg">
      <button id="tabAll" class="active">All</button>
      <button id="tabFav">Favorites</button>
    </div>
    <select id="groupFilter"><option value="">All Groups</option></select>
    <div id="count" class="hint" style="margin-left:auto"></div>
  </div>

  <div class="wrap list" id="list"></div>
  <div id="empty" class="empty">contacts.csv ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>
  <div class="az" id="az"></div>

  <!-- Contact sheet -->
  <div class="sheet-back" id="sheetBack">
    <div class="sheet" id="sheet">
      <div class="sheet-head">
        <div class="avatar" id="sAvatar">?</div>
        <div style="flex:1">
          <div id="sName" class="nm"></div>
          <div id="sEmails" class="sub"></div>
        </div>
        <button id="favBtn" class="btn gray" title="Toggle favorite">‚òÜ</button>
      </div>
      <div id="sPhones"></div>
      <div id="sGroups" class="sub"></div>
      <div class="btnrow">
        <a id="dialLink" class="btn" href="#">Call</a>
        <a id="smsLink" class="btn gray" href="#">SMS</a>
        <button id="copyBtn" class="btn gray">Copy</button>
        <button id="vcfBtn" class="btn gray">vCard</button>
        <button id="editBtn" class="btn gray">Edit</button>
        <button id="delBtn" class="btn gray">Delete</button>
        <button id="closeBtn" class="btn gray">Close</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit -->
  <div class="sheet-back" id="formBack" style="display:none">
    <div class="sheet" id="formSheet">
      <div class="sheet-head"><div class="nm" id="formTitle">Add Contact</div></div>
      <div class="form">
        <input id="fName" placeholder="Name"/>
        <input id="fPhones" placeholder="Phones (comma separated)"/>
        <input id="fEmails" placeholder="Emails (comma separated)"/>
        <input id="fGroups" placeholder="Groups (comma separated)"/>
      </div>
      <div class="btnrow">
        <button id="saveBtn" class="btn">Save</button>
        <button id="cancelBtn" class="btn gray">Cancel</button>
      </div>
    </div>
  </div>

  <div class="footer">CSV ‚Üí iOS-style ¬∑ Multi-number lines with per-number Call/SMS/Copy ¬∑ Favorites ¬∑ Groups ¬∑ Add/Edit/Delete ¬∑ vCard ¬∑ Dark Mode ¬∑ PWA</div>

<script>
/* ===== LocalStorage keys ===== */
const LS_THEME='contacts_theme', LS_ADDS='contacts_adds', LS_EDITS='contacts_edits',
      LS_DELETED='contacts_deleted', LS_FAVS='contacts_favs';

/* ===== Helpers ===== */
function getParam(n){ try{ return new URL(location.href).searchParams.get(n);}catch{ return null; } }
function splitMulti(v){return (v||'').split(':::').join(',').split(/[;,]/).map(s=>s.trim()).filter(Boolean);}
function uniq(a){return [...new Set(a.filter(Boolean))];}
function makeId(c){return (c.name||'')+'|'+(c.phones[0]||'')+'|'+(c.emails?.[0]||'');}
function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadLS(k,def){ try{ const v=JSON.parse(localStorage.getItem(k)); return v??def; }catch{ return def; } }

/* ===== CSV Parser ===== */
function parseCSV(t){
  const rows=[]; let cur="", row=[], i=0, q=false;
  while(i<t.length){
    const ch=t[i];
    if(q){
      if(ch=='"'){ if(t[i+1]=='"'){cur+='"'; i+=2;} else {q=false; i++;} }
      else { cur+=ch; i++; }
    } else {
      if(ch=='"'){ q=true; i++; }
      else if(ch==','){ row.push(cur); cur=""; i++; }
      else if(ch=='\r'){ i++; }
      else if(ch=='\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; }
      else { cur+=ch; i++; }
    }
  }
  if(cur!=="" || row.length){ row.push(cur); rows.push(row); }
  return rows;
}
function detectNameCol(h){const p=['name','given name','display name','full name','formatted name'];for(const x of p){const i=h.findIndex(a=>(a||'').toLowerCase().includes(x));if(i>=0)return i}return h.findIndex(Boolean)||0}
function detectPhoneCols(h){const out=[];h.forEach((v,i)=>{const k=(v||'').toLowerCase(); if(k.includes('phone')||/phone\s*\d|mobile|home|work/.test(k)) out.push(i);}); return [...new Set(out)];}
function detectEmailCols(h){const out=[];h.forEach((v,i)=>{if((v||'').toLowerCase().includes('email')) out.push(i)}); return [...new Set(out)];}
function detectGroupCol(h){const i=h.findIndex(v=>(v||'').toLowerCase().includes('group')); return i>=0? i : -1;}

/* ===== State ===== */
let baseContacts=[], contacts=[], current=null, filterFav=false, filterGroup="", searchTerm="";
let groupsSet=new Set();

/* ===== Theme ===== */
(function initTheme(){
  const saved=loadLS(LS_THEME,null);
  const preferDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = saved===null ? preferDark : saved==='dark';
  document.body.classList.toggle('dark', dark);
})();
document.getElementById('themeBtn').onclick=()=>{
  const dark=!document.body.classList.contains('dark');
  document.body.classList.toggle('dark', dark);
  saveLS(LS_THEME, dark?'dark':'light');
};

/* ===== Build from CSV + merge local changes ===== */
function hydrateFromCSVText(text){
  groupsSet=new Set();
  const rows=parseCSV(text);
  const headers=rows.shift()||[];
  const nameIdx=detectNameCol(headers);
  const phoneIdxs=detectPhoneCols(headers);
  const emailIdxs=detectEmailCols(headers);
  const groupIdx=detectGroupCol(headers);

  baseContacts = rows.map(r=>{
    const name=(r[nameIdx]||'').trim();
    const phones = uniq(phoneIdxs.flatMap(i=> splitMulti(r[i]||'')));
    const emails = uniq(emailIdxs.map(i=>(r[i]||'').trim()));
    let groups = [];
    if(groupIdx>=0){
      groups = uniq((r[groupIdx]||'').split(':::').flatMap(s=>s.split(','))).map(s=>s.trim()).filter(Boolean);
    }
    groups.forEach(g=>groupsSet.add(g));
    const key=(name||(phones[0]||'#'))[0]||'#';
    const id=makeId({name,phones,emails});
    return {id,name,phones,emails,groups,key,fav:false,source:'csv',deleted:false};
  }).filter(c=>c.name || c.phones.length || c.emails?.length);

  mergeLocalChanges();
  renderFiltered();
  buildGroupFilter();
}
function mergeLocalChanges(){
  const adds=loadLS(LS_ADDS,[]);
  const edits=loadLS(LS_EDITS,{});
  const dels = new Set(loadLS(LS_DELETED,[]));
  const favs = new Set(loadLS(LS_FAVS,[]));

  const map=new Map(baseContacts.map(c=>[c.id,{...c}]));

  // deletions
  dels.forEach(id=>{ if(map.has(id)) map.get(id).deleted=true; });

  // edits
  Object.entries(edits).forEach(([id,patch])=>{
    if(map.has(id)){
      const c=map.get(id);
      Object.assign(c, patch);
      c.key=(c.name||(c.phones[0]||'#'))[0]||'#';
      (c.groups||[]).forEach(g=>groupsSet.add(g));
    }
  });

  // adds
  adds.forEach(c=>{
    const id=c.id || (c.id=makeId(c));
    (c.groups||[]).forEach(g=>groupsSet.add(g));
    map.set(id,{...c,source:'local',deleted:false});
  });

  // favs
  map.forEach(c=>{ c.fav=favs.has(c.id); });

  contacts=[...map.values()].filter(c=>!c.deleted)
            .sort((a,b)=>(a.name||'').localeCompare(b.name||'','bn-BD'));
}
function buildGroupFilter(){
  const sel=document.getElementById('groupFilter');
  const cur=sel.value;
  sel.innerHTML='<option value="">All Groups</option>';
  [...groupsSet].sort((a,b)=>a.localeCompare(b)).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g; opt.textContent=g; sel.appendChild(opt);
  });
  sel.value=cur||"";
}

/* ===== Render ===== */
const listEl=document.getElementById('list'), emptyEl=document.getElementById('empty'),
      countEl=document.getElementById('count'), azEl=document.getElementById('az');
function buildSections(items){
  const map=new Map();
  for(const c of items){
    const letter=((c.key||'#')+'').toUpperCase();
    const L=/[A-Z‡¶Ö-‡¶π]/.test(letter)?letter:'#';
    if(!map.has(L)) map.set(L,[]);
    map.get(L).push(c);
  }
  const letters=[...map.keys()].sort((a,b)=>{
    if(a==='#' && b!=='#') return 1;
    if(b==='#' && a!=='#') return -1;
    return a.localeCompare(b,'en');
  });
  return letters.map(L=>({letter:L,items:map.get(L).sort((a,b)=>(a.name||'').localeCompare(b.name||'','bn-BD'))}));
}
function getFiltered(){
  let items=contacts;
  if(searchTerm){
    const q=searchTerm.toLowerCase();
    items=items.filter(c=>{
      if((c.name||'').toLowerCase().includes(q)) return true;
      if(c.phones.some(p=>p.toLowerCase().includes(q))) return true;
      if((c.emails||[]).some(e=>e.toLowerCase().includes(q))) return true;
      return false;
    });
  }
  if(filterFav) items=items.filter(c=>c.fav);
  if(filterGroup) items=items.filter(c=>(c.groups||[]).includes(filterGroup));
  return items;
}
function renderFiltered(){
  const items=getFiltered(); listEl.innerHTML=''; azEl.innerHTML='';
  if(!items.length){ emptyEl.style.display='block'; emptyEl.textContent='‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßá‡¶≤‡ßá‡¶®‡¶ø'; countEl.textContent='0 shown'; return; }
  emptyEl.style.display='none';
  const secs=buildSections(items);
  let total=0;
  secs.forEach(sec=>{
    const wrap=document.createElement('div'); wrap.className='section'; wrap.id='sec_'+sec.letter;
    const t=document.createElement('div'); t.className='sectitle'; t.textContent=sec.letter; wrap.appendChild(t);
    sec.items.forEach(c=>{
      total++;
      const cell=document.createElement('div'); cell.className='cell'; cell.tabIndex=0; cell.role='button';
      const av=document.createElement('div'); av.className='avatar'; av.textContent=(c.name||'?')[0]||'?';
      const mid=document.createElement('div');
      const nm=document.createElement('div'); nm.className='nm'; nm.textContent=c.name||'‚Äî unnamed ‚Äî';
      const sub=document.createElement('div'); sub.className='sub'; sub.textContent=c.phones[0] || (c.emails?.[0]||'');
      mid.appendChild(nm); mid.appendChild(sub);
      const arrow=document.createElement('div'); arrow.className='right'; arrow.textContent=c.fav?'‚òÖ':'‚Ä∫';
      cell.append(av,mid,arrow);
      cell.addEventListener('click',()=>openSheet(c));
      cell.addEventListener('keypress',e=>{ if(e.key==='Enter') openSheet(c); });
      wrap.appendChild(cell);
    });
    listEl.appendChild(wrap);
  });
  // A‚ÄìZ
  const letters=[...new Set(secs.map(s=>s.letter))];
  letters.forEach(L=>{ const a=document.createElement('a'); a.href='#sec_'+L; a.textContent=L; azEl.appendChild(a); });
  countEl.textContent = items.length+' contacts shown';
}

/* ===== Sheet (view) ===== */
const sheetBack=document.getElementById('sheetBack'), sheet=document.getElementById('sheet');
const sAvatar=document.getElementById('sAvatar'), sName=document.getElementById('sName'), sEmails=document.getElementById('sEmails');
const sPhones=document.getElementById('sPhones'), sGroups=document.getElementById('sGroups');
const favBtn=document.getElementById('favBtn'), dialLink=document.getElementById('dialLink'), smsLink=document.getElementById('smsLink'), copyBtn=document.getElementById('copyBtn'), vcfBtn=document.getElementById('vcfBtn'), editBtn=document.getElementById('editBtn'), delBtn=document.getElementById('delBtn'), closeBtn=document.getElementById('closeBtn');

function openSheet(c){
  current=c;
  sAvatar.textContent=(c.name||'?')[0]||'?';
  sName.textContent=c.name||'‚Äî unnamed ‚Äî';
  sEmails.textContent=(c.emails||[]).join(' ¬∑ ');
  sGroups.textContent=(c.groups&&c.groups.length)?('Groups: '+c.groups.join(', ')):'';
  // numbers (one per line + actions)
  sPhones.innerHTML='';
  const list=document.createElement('div'); list.className='numlist';
  (c.phones||[]).forEach(p=>{
    const row=document.createElement('div'); row.className='numrow';
    const num=document.createElement('span'); num.className='num'; num.textContent=p;
    const aCall=document.createElement('a'); aCall.className='btn sm'; aCall.textContent='Call'; aCall.href='tel:'+encodeURIComponent(p); aCall.target='_self';
    const aSMS=document.createElement('a'); aSMS.className='btn sm gray'; aSMS.textContent='SMS'; aSMS.href='sms:'+encodeURIComponent(p); aSMS.target='_self';
    const btnCopy=document.createElement('button'); btnCopy.className='btn sm gray'; btnCopy.textContent='Copy';
    btnCopy.onclick=async ()=>{ await navigator.clipboard.writeText(p); btnCopy.textContent='Copied'; setTimeout(()=>btnCopy.textContent='Copy',800); };
    row.append(num,aCall,aSMS,btnCopy);
    list.appendChild(row);
  });
  sPhones.appendChild(list);

  const main=c.phones?.[0]||'';
  dialLink.href= main? 'tel:'+encodeURIComponent(main) : '#';
  smsLink.href = main? 'sms:'+encodeURIComponent(main) : '#';
  copyBtn.onclick= async ()=>{ if(main){ await navigator.clipboard.writeText(main); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',800); } };
  vcfBtn.onclick=()=> exportVCF([c]);
  editBtn.onclick=()=> openForm('edit', c);
  delBtn.onclick=()=> deleteContact(c);
  favBtn.textContent=c.fav?'‚òÖ':'‚òÜ';
  favBtn.onclick=()=> toggleFav(c);

  sheetBack.style.display='block'; requestAnimationFrame(()=> sheet.classList.add('show'));
}
function closeSheet(){ sheet.classList.remove('show'); setTimeout(()=> sheetBack.style.display='none', 200); }
sheetBack.addEventListener('click',e=>{ if(e.target===sheetBack) closeSheet(); });
closeBtn.addEventListener('click',closeSheet);

/* ===== Add / Edit / Delete (localStorage) ===== */
const formBack=document.getElementById('formBack'), formSheet=document.getElementById('formSheet');
const formTitle=document.getElementById('formTitle'), fName=document.getElementById('fName'), fPhones=document.getElementById('fPhones'), fEmails=document.getElementById('fEmails'), fGroups=document.getElementById('fGroups');
const saveBtn=document.getElementById('saveBtn'), cancelBtn=document.getElementById('cancelBtn');
let formMode='add', editingId=null;

document.getElementById('addBtn').onclick=()=> openForm('add');
function openForm(mode,c=null){
  formMode=mode; formTitle.textContent=mode==='add'?'Add Contact':'Edit Contact';
  if(mode==='edit' && c){ editingId=c.id; fName.value=c.name||''; fPhones.value=(c.phones||[]).join(', '); fEmails.value=(c.emails||[]).join(', '); fGroups.value=(c.groups||[]).join(', '); }
  else { editingId=null; fName.value=''; fPhones.value=''; fEmails.value=''; fGroups.value=''; }
  formBack.style.display='block'; requestAnimationFrame(()=> formSheet.classList.add('show'));
}
function closeForm(){ formSheet.classList.remove('show'); setTimeout(()=> formBack.style.display='none', 200); }
formBack.addEventListener('click',e=>{ if(e.target===formBack) closeForm(); });
cancelBtn.addEventListener('click',closeForm);

saveBtn.onclick=()=>{
  const name=fName.value.trim();
  const phones=uniq(splitMulti(fPhones.value));
  const emails=uniq(fEmails.value.split(',').map(s=>s.trim()));
  const groups=uniq(fGroups.value.split(',').map(s=>s.trim()));
  if(!name && !phones.length && !emails.length){ alert('At least name or one phone/email ‡¶¶‡¶ø‡¶®'); return; }

  if(formMode==='add'){
    const c={id:makeId({name,phones,emails}), name, phones, emails, groups, key:(name||(phones[0]||'#'))[0]||'#', fav:false, source:'local', deleted:false};
    const adds=loadLS(LS_ADDS,[]); adds.push(c); saveLS(LS_ADDS,adds);
  } else {
    const edits=loadLS(LS_EDITS,{}); edits[editingId]={...(edits[editingId]||{}), name, phones, emails, groups}; saveLS(LS_EDITS,edits);
  }
  closeForm(); mergeLocalChanges(); renderFiltered(); buildGroupFilter();
};
function deleteContact(c){
  if(!confirm('Delete this contact?')) return;
  if(c.source==='local'){
    const adds=loadLS(LS_ADDS,[]).filter(x=>x.id!==c.id); saveLS(LS_ADDS,adds);
  }else{
    const dels=new Set(loadLS(LS_DELETED,[])); dels.add(c.id); saveLS(LS_DELETED,[...dels]);
  }
  closeSheet(); mergeLocalChanges(); renderFiltered();
}
function toggleFav(c){
  const favs=new Set(loadLS(LS_FAVS,[]));
  if(favs.has(c.id)) favs.delete(c.id); else favs.add(c.id);
  saveLS(LS_FAVS,[...favs]);
  mergeLocalChanges(); renderFiltered();
  if(current && current.id===c.id){ openSheet(contacts.find(x=>x.id===c.id)); }
}

/* ===== vCard export ===== */
function contactToVCF(c){
  const name=c.name||'Unknown', parts=name.split(' '), family=parts.slice(-1)[0]||'', given=parts.slice(0,-1).join(' ')||'';
  let v='BEGIN:VCARD\r\nVERSION:3.0\r\n';
  v+=`N:${family};${given};;;\r\n`; v+=`FN:${name}\r\n`;
  (c.emails||[]).forEach(e=> v+=`EMAIL;TYPE=INTERNET:${e}\r\n`);
  (c.phones||[]).forEach(p=> v+=`TEL;TYPE=CELL:${p}\r\n`);
  if(c.groups?.length) v+=`CATEGORIES:${c.groups.join(',')}\r\n`;
  v+='END:VCARD\r\n'; return v;
}
function exportVCF(arr){
  const blob=new Blob([arr.map(contactToVCF).join('')],{type:'text/vcard;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=arr.length===1?(arr[0].name||'contact')+'.vcf':'contacts.vcf'; a.click();
}
document.getElementById('exportAllBtn').onclick=()=> exportVCF(getFiltered());

/* ===== Search / Tabs / Filters ===== */
const qEl=document.getElementById('q'); document.getElementById('clear').onclick=()=>{ qEl.value=''; searchTerm=''; renderFiltered(); };
qEl.addEventListener('input',()=>{ searchTerm=qEl.value.trim(); renderFiltered(); });
document.getElementById('tabAll').onclick=()=>{ filterFav=false; setTab('tabAll'); renderFiltered(); };
document.getElementById('tabFav').onclick=()=>{ filterFav=true; setTab('tabFav'); renderFiltered(); };
function setTab(id){ document.getElementById('tabAll').classList.remove('active'); document.getElementById('tabFav').classList.remove('active'); document.getElementById(id).classList.add('active'); }
document.getElementById('groupFilter').onchange=e=>{ filterGroup=e.target.value||""; renderFiltered(); };

/* ===== CSV loader (+ ?src= + fallback picker) ===== */
async function loadCSV(){
  const src=getParam('src') || 'contacts.csv';
  try{
    const res=await fetch(src+(src.includes('?')?'&':'?')+'t='+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    hydrateFromCSVText(await res.text());
  }catch(err){
    console.error('CSV load failed:',err);
    emptyEl.style.display='block';
    emptyEl.innerHTML='‚ö†Ô∏è contacts.csv ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ <br> ‡¶®‡ßÄ‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶®‡•§';
    attachFallbackPicker();
  }
}
function attachFallbackPicker(){
  if(document.getElementById('pickWrap')) return;
  const wrap=document.createElement('div'); wrap.id='pickWrap'; wrap.style.marginTop='12px';
  wrap.innerHTML=`<input id="pickCsv" type="file" accept=".csv" style="display:none"/><button id="pickBtn" class="btn gray" style="padding:8px 12px">Choose CSV</button>`;
  emptyEl.appendChild(wrap);
  document.getElementById('pickBtn').onclick=()=> document.getElementById('pickCsv').click();
  document.getElementById('pickCsv').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return; hydrateFromCSVText(await f.text());
  });
}
document.getElementById('reloadBtn').onclick=()=> loadCSV();

/* ===== Keyboard nicety ===== */
window.addEventListener('keydown',e=>{ if(e.key==='/'){ e.preventDefault(); qEl.focus(); } });

/* ===== PWA (manifest + SW) ===== */
(function setupPWA(){
  const manifest = {
    name: "Contacts ‚Äî iOS Style",
    short_name: "Contacts",
    start_url: "./",
    display: "standalone",
    background_color: "#f8f8f8",
    theme_color: "#f8f8f8",
    icons: [
      { "src": "icons/icon-192.png",      "sizes": "192x192", "type": "image/png" },
      { "src": "icons/icon-512.png",      "sizes": "512x512", "type": "image/png" },
      { "src": "icons/maskable-512.png",  "sizes": "512x512", "type": "image/png", "purpose": "maskable any" }
    ]
  };
  const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link'); link.rel='manifest'; link.href=URL.createObjectURL(mBlob); document.head.appendChild(link);
  if('serviceWorker' in navigator){
    const swCode=`const C='cntc-cache-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])).then(()=>self.skipWaiting()))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(k=>Promise.all(k.filter(x=>x!==C).map(x=>caches.delete(x)))));self.clients.claim()});self.addEventListener('fetch',e=>{const u=new URL(e.request.url);if(u.origin===location.origin){e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const cl=res.clone();if(e.request.method==='GET'&&res.ok)caches.open(C).then(c=>c.put(e.request,cl));return res}).catch(()=>caches.match('./'))))}});`;
    const swBlob=new Blob([swCode],{type:'text/javascript'}); const swURL=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL).catch(console.error);
  }
})();

/* ===== Init ===== */
loadCSV();
</script>
</body>
</html>
